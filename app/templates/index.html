<html>


<head>

    <title>DB Jeeves</title>

    {% include 'jquery.jinja' %}

    <script src="https://cdn.jsdelivr.net/npm/jquery.fancytree@2.27/dist/jquery.fancytree-all-deps.min.js"></script>

    <script src="https://pagecdn.io/lib/ace/1.4.12/ace.min.js"></script>
    <script src="https://pagecdn.io/lib/ace/1.4.12/ext-language_tools.min.js"></script>
    <script src="https://pagecdn.io/lib/ace/1.4.12/ext-prompt.js" crossorigin="anonymous"></script>
    <!-- <script src="https://pagecdn.io/lib/ace/1.4.12/keybinding-vscode.js"></script> -->
    <script src="https://pagecdn.io/lib/ace/1.4.12/keybinding-vim.js"></script>
    <script src="https://pagecdn.io/lib/ace/1.4.12/theme-kuroir.min.js"></script>
    <script src="https://pagecdn.io/lib/ace/1.4.12/mode-{{script_lang}}.min.js"></script>
    <script src="https://pagecdn.io/lib/ace/1.4.12/mode-html.min.js"></script>
    <script src="https://pagecdn.io/lib/ace/1.4.12/mode-ejs.js" crossorigin="anonymous"></script>

    <style>
        body {
            margin: 0px;
            overflow-y: hidden;
            background-color: rgb(235, 203, 175);
        }

        #main-container {
            height: 100%;
            margin-left: 5%;
            margin-right: 5%;
        }

        #padded-container {
            background-color: rgb(255, 242, 230);
            height: 100%;
            margin-left: 5%;
            margin-right: 5%;
            padding-left: 3%;
            padding-right: 3%;
        }

        #controls {
            padding-bottom: 1%;
            padding-left: 1%;
        }

        #suite {
            display: flex;
            height: 70%;
        }

        #tree-container {
            overflow-y: none;
            min-width: 15%;
            max-height: 100%;
        }

        #tree {
            overflow: auto;
        }

        #editor-container {
            width: 100%;
        }

        #editor {
            width: 100%;
            height: 100%;
        }

        #user-name {
            /* font-size: 25; */

        }

        .fancytree-container {
            background-color: #e8e8e8 !important;
            height: auto;
        }
    </style>
</head>

<body>
    <div id="#main-container">
        <div id="padded-container">
            <br>
            <div id="user-name" align="center">
                <div>Made by: {{current_user.nickname}}</div>
                <div>Vendor: {{current_user.vendor}}</div>
                <div style="margin-top:1%;"><button onclick="share()">Share</button></div>
            </div>
            <div style="margin-bottom:1%;">
                <a href="/">Back</a>
            </div>
            <div id="is-synced">SYNCED</div>

            <div id="controls" style="padding:0px;margin-top:1%;margin-bottom:1%;">
                <button onclick="restartInstance()">Restart</button>
                <a href="/get_logs">Logs</a>
                <a href="/edit_sql">SQL</a>
                {% if has_diagram %}
                <a target="_blank" href="/view_diagram">Diagram</a>
                {% if current_user.vendor and current_user.vendor=="mysql" %}
                <a target="_blank" href="/get_diagram_mysql">(Redo)</a>
                {% else %}
                <a target="_blank" href="/get_diagram_pg">(Redo)</a>
                {% endif %}
                {% else %}
                {% if current_user.vendor and current_user.vendor=="mysql" %}
                <a target="_blank" href="/get_diagram_mysql">CreateDiagram</a>
                {% else %}
                <a target="_blank" href="/get_diagram_pg">CreateDiagram</a>
                {% endif %}
                {% endif %}
                <img id="spinner" style="display:none;max-height:16px;width:64px;"
                    src="https://i.gifer.com/origin/3e/3ef326d43744e0877c24b8c07542a2e7_w200.gif"></img>
                <a id="port" target="_blank" href="">Instance</a>
            </div>
            <div id="suite">

                <div id="tree-container">
                    <div id="tree"></div>
                </div>

                <div id="editor-container">
                    <div id="editor"></div>
                </div>
            </div>
        </div>
    </div>

    <script>

        let EditSession = require("ace/edit_session").EditSession;
        let UndoManager = require("ace/undomanager").UndoManager;
        ace.require("ace/ext/language_tools");
        let undoManager = new UndoManager();

        Storage.prototype.setObject = function (key, value) {
            this.setItem(key, JSON.stringify(value));
        }

        Storage.prototype.getObject = function (key) {
            var value = this.getItem(key);
            return value && JSON.parse(value);
        }

        function isObjNull(obj) {
            return obj && Object.keys(obj).length === 0 && obj.constructor === Object;
        }

        function initSession(dkey, content) {
            let extension = function (dkey_split) {
                if (dkey_split.length > 1)
                    return dkey_split.pop();
            }(function (_dkey) {
                return _dkey.split('.');
            }(dkey));

            let session = new EditSession(content);
            if (extension === 'html') {
                session.setMode("ace/mode/html");
            } else if (extension === 'php') {
                session.setMode("ace/mode/php");
            } else if (extension === 'ejs') {
                session.setMode("ace/mode/ejs");
            }
            else {
                session.setMode("ace/mode/{{script_lang}}");
            }
            session.on("change", function (e) {
                let doc_txt = session.getDocument().getValue();
                setKeyAndSaveMarked(dkey, doc_txt);
                setKeyAndSaveCached(dkey, doc_txt);
                $("#is-synced").text("NOT SYNCED");
            });

            session.setUndoManager(undoManager);

            return session;
        }

        function copyToClipboard(textToCopy) {
            // navigator clipboard api needs a secure context (https)
            if (navigator.clipboard && window.isSecureContext) {
                // navigator clipboard api method'
                return navigator.clipboard.writeText(textToCopy);
            } else {
                // text area method
                let textArea = document.createElement("textarea");
                textArea.value = textToCopy;// make the textarea out of viewport
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                return new Promise((res, rej) => {
                    // here the magic happens
                    document.execCommand('copy') ? res() : rej();
                    textArea.remove();
                });
            }
        }

        function share() {
            copyToClipboard(window.location.host + "/view_project/{{current_user.identity}}")
                .then(function () {
                    alert("Link copied to clipboard.");
                })
                .catch(function () { });
        }

        function postAjax(url, data, success = function (data) { console.log(data) }) {
            $.ajax({
                url: url,
                type: "POST",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(data),
                success: success,
                error: function (xhr, status, error) {
                    console.log(error);
                },
            });
        }

        function syncChanges() {
            let dirt = localStorage.getObject("mark_dirty");
            postAjax('/sync_changes', dirt, function (data) {
                localStorage.setObject("mark_dirty", {});
                $("#is-synced").text("SYNCED");
            });
        }

        function restartInstance() {
            let user_name = localStorage.getObject("user_name");
            $("#spinner").show();
            $("#port").hide();
            $.ajax({
                url: '/restart_instance',
                type: "POST",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ 'user': user_name }),
                success: function (data) {
                    let [ip, _] = window.location.host.split(":");
                    let instance_url = "http://" + ip + ":" + data.port;
                    localStorage.setObject("instance_url", instance_url);
                    $("#port").attr("href", instance_url);
                },
                error: function (xhr, status, error) {
                    console.log(error);
                },
                complete: function (data) {
                    $("#spinner").hide();
                    $("#port").show();
                }
            });
        };

        function getMarked() {
            let dirt = localStorage.getObject("mark_dirty");
            return dirt;
        }

        function setKeyAndSaveMarked(key, value) {
            let dirt = getMarked();
            dirt[key] = value;
            localStorage.setObject("mark_dirty", dirt);
        }

        function getCached() {
            let cached = localStorage.getObject("mark_cached");
            return cached;
        }

        function setKeyAndSaveCached(key, value) {
            let cached = getCached();
            cached[key] = value;
            localStorage.setObject("mark_cached", cached);
        }



        $(function () {

            localStorage.setObject("user_name", "{{current_user.identity}}");

            let instance_url = localStorage.getObject("instance_url");
            if (instance_url) {
                $("#port").attr("href", instance_url);
            } else {
                $(this).text("No instance online");
            }
            $("#port").click(function (e) {

                let instance_url = localStorage.getObject("instance_url");
                if (instance_url) {
                    return;
                } else {
                    e.preventDefault();
                    $(this).text("No instance online");
                }
            });

            let editor1 = ace.edit("editor");
            editor1.setOptions({
                enableBasicAutocompletion: true,
                enableLiveAutocompletion: true,
            });
            // editor1.setKeyboardHandler("ace/keyboard/vim");
            editor1.commands.addCommand({
                name: 'save',
                bindKey: { win: "Ctrl-S", "mac": "Cmd-S" },
                exec: function (editor) {
                    syncChanges();
                }
            });
            editor1.commands.addCommand({
                name: 'restart',
                bindKey: { win: "Ctrl-R", "mac": "Cmd-S" },
                exec: function (editor) {
                    restartInstance();
                }
            });
            editor1.setTheme("ace/theme/kuroir");
            editor1.setFontSize(15);
            let last_edited = localStorage.getObject("last_edited");
            if (last_edited) {
                let cached = getCached();
                let content = cached[last_edited];
                if (content) {
                    let session = initSession(last_edited, content);
                    editor1.setSession(session);
                }
            } else {
                editor1.session.setValue('Pick a node to start working!\nDouble click item to add node;\nSelect node and press Del to delete it;\nCTRL-S to save;\nCTRL-R to restart.');
            }


            $("#tree").fancytree({
                extensions: ["edit"],
                skin: "lion",
                checkbox: false,
                expanded: true,
                source: function () {
                    let tcont = localStorage.getItem("tree_content");
                    let force_update = JSON.parse(`{{force_update}}`);

                    if (force_update || (tcont === null)) {
                        return $.ajax({
                            url: "/get_dir",
                            type: "POST",
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            data: JSON.stringify({ "dir": "{{ app_path }}" }),
                            success: function (data) {
                                localStorage.setObject("tree_content", data);
                                localStorage.setObject("mark_dirty", {});
                                localStorage.setObject("mark_cached", {});
                                localStorage.setObject("last_edited", null);
                                $("#is-synced").text("SYNCED");
                                window.setTimeout(function () {
                                    let [url, arg] = window.location.href.split('?');
                                    if (url !== window.location.url) {
                                        window.location.href = url;
                                    }
                                }, 1);
                            },
                        });
                    }
                    if (isObjNull(localStorage.getObject("mark_dirty"))) {
                        $("#is-synced").text("SYNCED");
                    } else {
                        $("#is-synced").text("NOT SYNCED");
                    }
                    return JSON.parse(tcont);
                },
                edit: {
                    beforeClose: function (event, data) {
                        window.setTimeout(function () {
                            if (data.node && data.node.title !== '') {
                                let node_path = data.node.parent.key + "/" + data.node.title;
                                data.node.key = node_path;

                                setKeyAndSaveMarked(node_path, "hello world");

                                let d = data.tree.toDict(true);
                                localStorage.setObject("tree_content", d);
                                $("#is-synced").text("NOT SYNCED");
                            }
                        }, 3);
                    }
                },

                dblclick: function (event, data) {
                    data.node.editCreateNode("after", {
                        title: "",
                        folder: false
                    });
                },
                keydown: function (event, data) {
                    switch (event.which) {
                        case 46: {
                            $.ajax({
                                url: '/rm_file',
                                type: "POST",
                                dataType: "json",
                                contentType: "application/json; charset=utf-8",
                                data: JSON.stringify({ "path": data.node.key }),
                                success: function (ds) {
                                    data.node.remove();
                                    let d = data.node.tree.toDict(true);
                                    localStorage.setObject("tree_content", d);
                                }
                            }).fail(function () {
                                let dirt = localStorage.getObject("mark_dirty");
                                delete dirt[data.node.key];
                                localStorage.setObject("mark_dirty", dirt);

                                data.node.remove();
                                let d = data.tree.toDict(true);
                                localStorage.setObject("tree_content", d);
                                if (isObjNull(dirt)) {
                                    $("#is-synced").text("SYNCED");
                                }
                            });
                            break;
                        }
                    }
                },
                activate: function (event, data) {
                    let dkey = data.node.key;
                    if (!data.node.folder) {

                        localStorage.setObject("last_edited", dkey);

                        let dirt = getCached();

                        let editing = dirt[dkey];

                        if (editing) {
                            let session = initSession(dkey, editing);
                            editor1.setSession(session);
                            return;
                        }

                        $.ajax({
                            url: "/get_file",
                            type: "POST",
                            contentType: "application/json; charset=utf-8",
                            data: JSON.stringify({ "path": dkey }),
                            dataType: "json",
                            success: function (resp_data) {
                                setKeyAndSaveCached(dkey, resp_data.content);
                                let session = initSession(dkey, resp_data.content);
                                editor1.setSession(session);
                            },
                            error: function (xhr, status, error) {
                                console.log(status, error);
                            }
                        });

                        // $("#status").text("Activate: " + data.node.title);
                    }
                },
            });

        });
    </script>
</body>

</html>